<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f0f0f" />
  <title>pH Node</title>

  <style>
    :root{
      --bg:#0f0f0f;
      --panel:#141414;
      --panel2:#101010;
      --border:#2a2a2a;
      --text:#f2f2f2;
      --muted:#b8b8b8;
      --accent:#2a8cff;
      --ok:#36c17b;
      --bad:#ff5a5a;
      --warn:#ffcc66;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 50% -10%, rgba(42,140,255,.18), transparent 55%),
        radial-gradient(900px 600px at 15% 110%, rgba(54,193,123,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .wrap{max-width:1050px; margin:0 auto; padding:18px 14px 40px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:5;
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width: 220px;
    }
    .brand .t{font-weight:900; letter-spacing:.2px; font-size:16px}
    .brand .s{color:var(--muted); font-size:12px}
    .pills{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .pill.ok{border-color:rgba(54,193,123,.35); color:#c8ffe4}
    .pill.bad{border-color:rgba(255,90,90,.35); color:#ffd1d1}
    .pill.warn{border-color:rgba(255,204,102,.35); color:#ffe8bf}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      .brand{min-width: unset}
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.18);
    }
    .card .hd h2{
      margin:0; font-size:14px; letter-spacing:.2px; font-weight:900;
    }
    .card .hd .hint{margin:0; color:var(--muted); font-size:12px}
    .card .bd{padding:14px}

    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:800; font-size:13px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .sep{height:1px; background:rgba(255,255,255,.06); margin:12px 0}

    .liveRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .liveRow{grid-template-columns:1fr}
    }
    .metric{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px 12px;
      min-height:72px;
    }
    .metric .label{font-size:12px; color:var(--muted)}
    .metric .value{
      margin-top:6px;
      font-size:22px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .metric .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .bigPh{font-size:30px}
    .quality{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .dot{
      width:10px; height:10px; border-radius:999px; background:#777;
      box-shadow:0 0 0 3px rgba(255,255,255,.06) inset;
    }
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}

    canvas{width:100%; height:140px; display:block; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.18)}
    .small{font-size:12px; color:var(--muted); line-height:1.45}

    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b0b0b;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(42,140,255,.9); box-shadow:0 0 0 3px rgba(42,140,255,.18)}
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .formGrid{grid-template-columns:1fr}
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .row3{grid-template-columns:1fr}
    }
    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    button{
      border:0;
      border-radius:14px;
      padding:11px 12px;
      font-weight:950;
      cursor:pointer;
      color:white;
      background:var(--accent);
      flex:1 1 180px;
    }
    button.secondary{
      background:#1b1b1b;
      color:var(--text);
      border:1px solid var(--border);
    }
    button.danger{
      background:var(--bad);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      box-shadow:var(--shadow);
      font-size:13px;
      display:none;
      max-width:min(880px, 92vw);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .links{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    a{color:var(--accent); text-decoration:none; font-weight:900}
    a:hover{text-decoration:underline}
    .mutedLink{color:var(--muted); font-weight:800}
    .foot{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      font-weight:850;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">pH Node</div>
        <div class="s" id="subtitle">—</div>
      </div>
      <div class="pills">
        <div class="pill" id="pill_wifi"><b>Wi-Fi</b> —</div>
        <div class="pill" id="pill_ip"><b>IP</b> —</div>
        <div class="pill" id="pill_mqtt"><b>MQTT</b> —</div>
        <div class="pill" id="pill_fs"><b>FS</b> —</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: live + chart + calibration -->
      <div class="col">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Live Reading</h2>
              <p class="hint">Updates every 1s (from <span class="mono">/api/ph</span>)</p>
            </div>
            <span class="quality" id="calBadge">
              <span class="dot" id="calDot"></span>
              <span id="calText">CAL —</span>
            </span>
          </div>
          <div class="bd">
            <div class="liveRow">
              <div class="metric">
                <div class="label">pH</div>
                <div class="value bigPh" id="m_ph">—</div>
                <div class="sub" id="m_ph_sub">Needs calibration</div>
              </div>
              <div class="metric">
                <div class="label">Voltage</div>
                <div class="value" id="m_v">—</div>
                <div class="sub">V (filtered)</div>
              </div>
              <div class="metric">
                <div class="label">ADC</div>
                <div class="value" id="m_adc">—</div>
                <div class="sub">raw</div>
              </div>
            </div>

            <div class="sep"></div>

            <canvas id="chart" width="1000" height="260" aria-label="Voltage trend"></canvas>
            <div class="foot">
              <div class="badge">Avg(10s): <span class="mono" id="m_avg">—</span> V</div>
              <div class="badge">Std: <span class="mono" id="m_std">—</span> V</div>
              <div class="badge">Last: <span class="mono" id="m_ts">—</span></div>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Calibration</h2>
              <p class="hint">ph value will only show after calibration is valid/strong</p>
            </div>
            <button class="danger" id="btnClearCal" type="button" style="flex:0 0 auto; padding:10px 12px; border-radius:14px">
              Clear
            </button>
          </div>
          <div class="bd">
            <div class="kv">
              <div class="k">Valid</div><div class="v" id="cal_valid">—</div>
              <div class="k">Quality</div><div class="v" id="cal_quality">—</div>
            </div>
            <div class="sep"></div>
            <div class="row3">
              <div class="metric">
                <div class="label">Point A</div>
                <div class="value" id="cal_A">—</div>
                <div class="sub" id="cal_A_sub">—</div>
              </div>
              <div class="metric">
                <div class="label">Point B</div>
                <div class="value" id="cal_B">—</div>
                <div class="sub" id="cal_B_sub">—</div>
              </div>
              <div class="metric">
                <div class="label">Hint</div>
                <div class="value" style="font-size:14px; font-weight:900; margin-top:8px">Use LCD Buttons</div>
                <div class="sub">Capture pH7 & pH4/10, then save.</div>
              </div>
            </div>

            <div class="sep"></div>
            <div class="small">
              Note: calibration requires two points of pH value. The voltage different between those two values need to be significant
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: device + mqtt -->
      <div class="col">
        <div class="card">
          <div class="hd">
            <div>
              <h2>Device</h2>
              <p class="hint">From <span class="mono">/api/status</span></p>
            </div>
          </div>
          <div class="bd">
            <div class="kv">
              <div class="k">Name</div><div class="v" id="d_name">—</div>
              <div class="k">Firmware</div><div class="v mono" id="d_fw">—</div>
              <div class="k">Uptime</div><div class="v" id="d_up">—</div>
              <div class="k">Wi-Fi mode</div><div class="v" id="d_wmode">—</div>
              <div class="k">SSID</div><div class="v" id="d_ssid">—</div>
              <div class="k">RSSI</div><div class="v" id="d_rssi">—</div>
              <div class="k">IP</div><div class="v mono" id="d_ip">—</div>
              <div class="k">FS used</div><div class="v" id="d_fs">—</div>
            </div>

            <div class="sep"></div>

            <div class="links">
              <a href="/setup">Wi-Fi Setup</a>
              <a href="/files">File Manager</a>
            </div>

            <div class="small" style="margin-top:10px">
              Note: file operations (<span class="mono">/files</span>, <span class="mono">/upload</span>, <span class="mono">/list</span>)
              are allowed only in AP mode (as enforced in firmware).
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>MQTT Settings</h2>
              <p class="hint">GET/POST <span class="mono">/api/settings/mqtt</span></p>
            </div>
          </div>
          <div class="bd">
            <form id="mqttForm">
              <div class="metric" style="padding:10px 12px">
                <label style="display:flex; gap:10px; align-items:center; cursor:pointer">
                  <input type="checkbox" id="mq_enabled" style="width:18px; height:18px; margin:0">
                  <span style="font-weight:950">Enable MQTT</span>
                  <span style="margin-left:auto; color:var(--muted); font-size:12px" id="mq_conn">—</span>
                </label>
              </div>

              <div style="height:10px"></div>

              <div class="formGrid">
                <div>
                  <div class="k" style="margin:2px 0 6px">Host</div>
                  <input id="mq_host" placeholder="e.g. 192.168.1.10">
                </div>
                <div>
                  <div class="k" style="margin:2px 0 6px">Port</div>
                  <input id="mq_port" placeholder="1883" inputmode="numeric">
                </div>
                <div>
                  <div class="k" style="margin:2px 0 6px">Username</div>
                  <input id="mq_user" placeholder="(optional)">
                </div>
                <div>
                  <div class="k" style="margin:2px 0 6px">Password</div>
                  <input id="mq_pass" placeholder="(optional)" type="password">
                </div>
              </div>

              <div style="height:10px"></div>

              <div class="formGrid">
                <div>
                  <div class="k" style="margin:2px 0 6px">Base topic</div>
                  <input id="mq_topic" placeholder="e.g. phnode">
                </div>
                <div>
                  <div class="k" style="margin:2px 0 6px">Publish period (ms)</div>
                  <input id="mq_period" placeholder="1000" inputmode="numeric">
                </div>
              </div>

              <div style="height:10px"></div>

              <div class="metric" style="padding:10px 12px">
                <label style="display:flex; gap:10px; align-items:center; cursor:pointer">
                  <input type="checkbox" id="mq_retain" style="width:18px; height:18px; margin:0">
                  <span style="font-weight:900">Retain messages</span>
                </label>
              </div>

              <div class="btnRow">
                <button type="submit" id="btnSaveMqtt">Save MQTT</button>
                <button type="button" class="secondary" id="btnTogglePass">Show Password</button>
              </div>
            </form>

            <div class="sep"></div>

            <div class="small">
              Need help? Visit <a href="https://github.com/zainalabidin85/pH-Sensor-Node" target="_blank">GitHub Zainal</a>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast">—</div>

  <script>
    const $ = (id) => document.getElementById(id);

    // --------------------------
    // Small utilities
    // --------------------------
    function fmtUptime(sec){
      sec = Math.max(0, sec|0);
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600);  sec %= 3600;
      const m = Math.floor(sec / 60);    const s = sec % 60;
      return (d? (d+"d ") : "") + String(h).padStart(2,"0")+":" + String(m).padStart(2,"0")+":" + String(s).padStart(2,"0");
    }
    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", 2600);
    }
    async function fetchJSON(url, timeoutMs=2500){
      const ctrl = new AbortController();
      const tm = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(url, {cache:"no-store", signal: ctrl.signal});
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(tm);
      }
    }
    async function postForm(url, fieldsObj){
      const fd = new FormData();
      for (const [k,v] of Object.entries(fieldsObj)) fd.append(k, v);
      const r = await fetch(url, {method:"POST", body: fd});
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r;
    }
    async function postJson(url, obj){
      const r = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(obj),
      });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r;
    }

    // --------------------------
    // Trend chart (voltage)
    // --------------------------
    const buf = {
      v: [],
      t: [],
      max: 80,
    };

    function pushPoint(v, tsMs){
      if (typeof v !== "number" || !isFinite(v)) return;
      buf.v.push(v);
      buf.t.push(tsMs || Date.now());
      if (buf.v.length > buf.max){
        buf.v.shift(); buf.t.shift();
      }
    }

    function drawChart(){
      const c = $("chart");
      const ctx = c.getContext("2d");
      const W = c.width, H = c.height;
      ctx.clearRect(0,0,W,H);

      // background grid
      ctx.globalAlpha = 1;
      ctx.lineWidth = 1;

      // simple palette without hardcoding many colors:
      // (we still draw with default strokeStyle; browser default is OK, but we set once for readability)
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.fillStyle = "rgba(255,255,255,0.10)";

      const pad = 22;
      const x0 = pad, y0 = pad, x1 = W - pad, y1 = H - pad;

      // box
      ctx.strokeRect(x0, y0, x1-x0, y1-y0);

      // horizontal grid
      for (let i=1;i<=3;i++){
        const y = y0 + (i*(y1-y0)/4);
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
      }

      if (buf.v.length < 2) return;

      const vMin = Math.min(...buf.v);
      const vMax = Math.max(...buf.v);
      const span = Math.max(0.001, vMax - vMin);
      const padV = span * 0.12;

      const lo = vMin - padV;
      const hi = vMax + padV;

      const N = buf.v.length;
      ctx.strokeStyle = "rgba(42,140,255,0.95)";
      ctx.lineWidth = 2;

      ctx.beginPath();
      for (let i=0;i<N;i++){
        const x = x0 + (i*(x1-x0)/(N-1));
        const vv = buf.v[i];
        const y = y1 - ((vv - lo) / (hi - lo)) * (y1 - y0);
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // last point
      const lastX = x1;
      const lastV = buf.v[N-1];
      const lastY = y1 - ((lastV - lo) / (hi - lo)) * (y1 - y0);
      ctx.fillStyle = "rgba(42,140,255,0.95)";
      ctx.beginPath(); ctx.arc(lastX,lastY,4,0,Math.PI*2); ctx.fill();

      // labels
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.font = "20px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillText("V", x0+8, y0+20);

      ctx.font = "18px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillText(hi.toFixed(3), x0+8, y0+44);
      ctx.fillText(lo.toFixed(3), x0+8, y1-10);
    }

    // --------------------------
    // UI update functions
    // --------------------------
    function setCalBadge(quality, valid){
      const dot = $("calDot");
      const txt = $("calText");

      let cls = "dot";
      let label = "CAL —";

      if (!valid){
        cls += " bad";
        label = "CAL NONE";
      } else if (quality === "OK"){
        cls += " ok";
        label = "CAL OK";
      } else if (quality === "WEAK"){
        cls += " warn";
        label = "CAL WEAK";
      } else {
        cls += " warn";
        label = "CAL ?";
      }
      dot.className = cls;
      txt.textContent = label;
    }

    function setPills(st){
      // Wi-Fi pill
      const mode = st?.wifi?.mode || "—";
      const connected = !!st?.wifi?.connected;
      const ssid = (st?.wifi?.ssid || "").trim();
      const rssi = (typeof st?.wifi?.rssi === "number") ? st.wifi.rssi : null;
      const ip = (st?.wifi?.ip || "—").trim() || "—";

      const wifiPill = $("pill_wifi");
      wifiPill.className = "pill " + (connected ? "ok" : (mode === "AP" ? "warn" : "bad"));
      wifiPill.innerHTML = "<b>Wi-Fi</b> " + (connected ? ("STA (" + (ssid || "—") + ")") : mode) + (rssi !== null ? (" · " + rssi + " dBm") : "");

      const ipPill = $("pill_ip");
      ipPill.className = "pill " + (connected ? "ok" : (mode === "AP" ? "warn" : ""));
      ipPill.innerHTML = "<b>IP</b> " + ip;

      // MQTT pill (firmware may compile without mqtt, but your main.cpp has ENABLE_MQTT=1)
      const mq = st?.mqtt;
      const mqttPill = $("pill_mqtt");
      if (mq){
        const mqOk = !!mq.connected;
        const mqEn = !!mq.enabled;
        mqttPill.className = "pill " + (mqEn ? (mqOk ? "ok" : "warn") : "");
        mqttPill.innerHTML = "<b>MQTT</b> " + (mqEn ? (mqOk ? "Connected" : "Enabled") : "Off");
      } else {
        mqttPill.className = "pill";
        mqttPill.innerHTML = "<b>MQTT</b> N/A";
      }

      // FS pill
      const used = st?.fs?.used ?? null;
      const total = st?.fs?.total ?? null;
      const fsPill = $("pill_fs");
      if (typeof used === "number" && typeof total === "number" && total > 0){
        const pct = Math.round((used/total)*100);
        fsPill.className = "pill";
        fsPill.innerHTML = "<b>FS</b> " + pct + "%";
      } else {
        fsPill.className = "pill";
        fsPill.innerHTML = "<b>FS</b> —";
      }
    }

    function renderDevice(st){
      const devName = st?.device?.name || "—";
      const fw = st?.device?.fw || "—";
      const up = st?.device?.uptime_s ?? null;

      $("d_name").textContent = devName;
      $("d_fw").textContent = fw;
      $("d_up").textContent = (typeof up === "number") ? fmtUptime(up) : "—";

      const mode = st?.wifi?.mode || "—";
      const connected = !!st?.wifi?.connected;
      $("d_wmode").textContent = mode + (connected ? " (connected)" : "");
      $("d_ssid").textContent = st?.wifi?.ssid || "—";
      const rssi = st?.wifi?.rssi;
      $("d_rssi").textContent = (typeof rssi === "number") ? (rssi + " dBm") : "—";
      $("d_ip").textContent = st?.wifi?.ip || "—";

      const used = st?.fs?.used ?? null;
      const total = st?.fs?.total ?? null;
      if (typeof used === "number" && typeof total === "number"){
        $("d_fs").textContent = (used/1024).toFixed(1) + " KB / " + (total/1024).toFixed(1) + " KB";
      } else {
        $("d_fs").textContent = "—";
      }

      $("subtitle").textContent = devName + " · FW " + fw;
      setPills(st);

      // calibration badge from status
      const valid = !!st?.cal?.valid;
      const quality = st?.cal?.quality || "NONE";
      setCalBadge(quality, valid);

      // MQTT connection text on form
      if (st?.mqtt){
        const en = !!st.mqtt.enabled;
        const con = !!st.mqtt.connected;
        const err = st.mqtt.last_error || "";
        $("mq_conn").textContent = en ? (con ? "Connected" : (err ? ("Err: " + err) : "Not connected")) : "Disabled";
      } else {
        $("mq_conn").textContent = "N/A";
      }
    }

    function renderPh(p){
      const adc = p?.adc;
      const v = p?.voltage;
      const ph = p?.ph;
      const avg = p?.v_avg_10s;
      const std = p?.v_std;
      const ts = p?.ts_ms;

      $("m_adc").textContent = (typeof adc === "number") ? adc : "—";
      $("m_v").textContent = (typeof v === "number") ? v.toFixed(3) : "—";
      $("m_avg").textContent = (typeof avg === "number") ? avg.toFixed(3) : "—";
      $("m_std").textContent = (typeof std === "number") ? std.toFixed(4) : "—";

      if (typeof ph === "number"){
        $("m_ph").textContent = ph.toFixed(2);
        $("m_ph_sub").textContent = "calculated";
      } else {
        $("m_ph").textContent = "—";
        $("m_ph_sub").textContent = "Needs calibration";
      }

      if (typeof ts === "number"){
        const ageMs = Math.max(0, Date.now() - (performance.timeOrigin + ts));
        // performance.timeOrigin trick may not line up with device millis; keep it simple:
        $("m_ts").textContent = ts + " ms";
      } else {
        $("m_ts").textContent = "—";
      }

      if (typeof v === "number"){
        pushPoint(v, ts);
        drawChart();
      }
    }

    function renderCal(c){
      const valid = !!c?.valid;
      const quality = c?.quality || "NONE";
      $("cal_valid").textContent = valid ? "Yes" : "No";
      $("cal_quality").textContent = quality;

      const A = c?.A || {};
      const B = c?.B || {};
      $("cal_A").textContent = A.set ? ("pH " + Number(A.ph).toFixed(2)) : "Not set";
      $("cal_A_sub").textContent = A.set ? ("V=" + Number(A.v).toFixed(3)) : "—";
      $("cal_B").textContent = B.set ? ("pH " + Number(B.ph).toFixed(2)) : "Not set";
      $("cal_B_sub").textContent = B.set ? ("V=" + Number(B.v).toFixed(3)) : "—";

      setCalBadge(quality, valid);
    }

    // --------------------------
    // MQTT form
    // --------------------------
    $("btnTogglePass").addEventListener("click", ()=>{
      const p = $("mq_pass");
      const show = p.type === "password";
      p.type = show ? "text" : "password";
      $("btnTogglePass").textContent = show ? "Hide Password" : "Show Password";
    });

    $("mqttForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("btnSaveMqtt").disabled = true;

      const enabled = $("mq_enabled").checked ? "1" : "0";
      const host = $("mq_host").value.trim();
      const port = ($("mq_port").value.trim() || "1883");
      const user = $("mq_user").value.trim();
      const pass = $("mq_pass").value; // allow spaces
      const topic = $("mq_topic").value.trim();
      const retain = $("mq_retain").checked ? "1" : "0";
      const period = ($("mq_period").value.trim() || "1000");

      try{
        await postForm("/api/settings/mqtt", {
          enabled, host, port, user, pass, topic,
          retain, period_ms: period
        });
        toast("MQTT saved ✓");
        await refreshStatus();
      } catch(err){
        toast("Save failed: " + (err?.message || err));
      } finally {
        $("btnSaveMqtt").disabled = false;
      }
    });

    async function loadMqttSettings(){
      try{
        const m = await fetchJSON("/api/settings/mqtt", 3000);
        $("mq_enabled").checked = !!m.enabled;
        $("mq_host").value = m.host || "";
        $("mq_port").value = (m.port || 1883);
        $("mq_user").value = m.user || "";
        $("mq_pass").value = ""; // firmware intentionally does not reveal
        $("mq_topic").value = m.topic || "";
        $("mq_retain").checked = !!m.retain;
        $("mq_period").value = (m.period_ms || 1000);
      } catch(e){
        // if mqtt disabled in firmware, this might fail; keep UI calm
      }
    }

    // --------------------------
    // Calibration clear
    // --------------------------
    $("btnClearCal").addEventListener("click", async ()=>{
      if (!confirm("Clear calibration points?")) return;
      $("btnClearCal").disabled = true;
      try{
        // firmware expects POST /api/cal/clear (no body required)
        const r = await fetch("/api/cal/clear", {method:"POST"});
        if(!r.ok) throw new Error("HTTP " + r.status);
        toast("Calibration cleared ✓");
        await refreshCal();
        await refreshStatus();
      } catch(err){
        toast("Clear failed: " + (err?.message || err));
      } finally {
        $("btnClearCal").disabled = false;
      }
    });

    // --------------------------
    // Poll loops
    // --------------------------
    let alive = true;

    async function refreshStatus(){
      const s = await fetchJSON("/api/status", 2500);
      renderDevice(s);
    }
    async function refreshPh(){
      const p = await fetchJSON("/api/ph", 2500);
      renderPh(p);
    }
    async function refreshCal(){
      const c = await fetchJSON("/api/cal", 2500);
      renderCal(c);
    }

    async function start(){
      // initial loads
      try{ await refreshStatus(); } catch(e){ toast("Status offline"); }
      await loadMqttSettings();
      try{ await refreshCal(); } catch(e){}
      try{ await refreshPh(); } catch(e){}

      // intervals (keep light)
      setInterval(async ()=>{
        if(!alive) return;
        try{ await refreshPh(); } catch(e){}
      }, 1000);

      setInterval(async ()=>{
        if(!alive) return;
        try{ await refreshCal(); } catch(e){}
      }, 2500);

      setInterval(async ()=>{
        if(!alive) return;
        try{ await refreshStatus(); } catch(e){}
      }, 5000);
    }

    window.addEventListener("visibilitychange", ()=>{
      alive = !document.hidden;
    });

    // go
    start();
  </script>
</body>
</html>
